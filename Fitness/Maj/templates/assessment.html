<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FitSmart AI — Assessment & Calendar</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- FullCalendar (CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --brand:#0fb15d; --brand-dark:#0a8e48; --accent:#3b82f6; --accent-dark:#2563eb; --muted:#6c757d; }
    body { background: linear-gradient(135deg,#f8fdf9,#f0f7ff); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .navbar{background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
    .btn-brand{background:var(--brand);color:#fff;border:none;}
    .btn-brand:hover{background:var(--brand-dark);}
    .badge-assessment{background:var(--brand);color:#fff;padding:0.35rem 0.75rem;border-radius:20px;font-size:.85rem}
    .badge-nutrition{background:var(--accent);color:#fff;padding:0.35rem 0.75rem;border-radius:20px;font-size:.85rem}
    .score-bar{height:24px;border-radius:12px;background:#e9f4ec;overflow:hidden;border:1px solid rgba(0,0,0,0.03)}
    .score-bar-fill{height:100%;text-align:right;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:flex-end;padding-right:10px}
    /* Calendar styling: explicit min-height to avoid invisible container */
    #calendar{background:#fff;border-radius:12px;padding:1rem; min-height:420px; box-shadow: 0 1px 6px rgba(0,0,0,0.04);}
    .log-row{cursor:pointer;transition:background .15s}
    .log-row:hover{background:#f8f9fa}
    .card-header .btn{font-size:.85rem}
    .muted-small{color:var(--muted);font-size:.85rem}
    .no-logs{padding:1.25rem;text-align:center;color:var(--muted)}
    @media (min-width: 992px){ #calendar{min-height:480px} }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg px-3 px-md-4">
    <a class="navbar-brand fw-bold text-success" href="{{ url_for('dashboard') }}">
      <i class="fas fa-brain-circuit"></i> FitSmart AI
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('assessment') }}">Assessment</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('nutrition') }}">Nutrition</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('progress') }}">Progress</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('workouts') }}">Workouts</a></li>
      </ul>

      {% if session.get('user') %}
        <div class="d-flex align-items-center gap-2">
          <span class="me-2">Welcome, <strong>{{ session.get('user') }}</strong></span>
          <a class="btn btn-outline-danger btn-sm" href="{{ url_for('logout') }}">Logout</a>
        </div>
      {% else %}
        <a class="btn btn-brand btn-sm" href="{{ url_for('login') }}">Login</a>
      {% endif %}
    </div>
  </nav>

  <div class="container my-4">
    <div class="row gy-4">
      <div class="col-lg-5">
        <!-- Quick Assessment -->
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center">
            <i class="fas fa-bolt me-2"></i> Quick Assessment
            <small class="muted-small ms-auto">Instant BMI & suggestions</small>
          </div>
          <div class="card-body">
            <!-- NOTE: form action kept for graceful degradation (non-JS fallback) -->
            <form method="POST" action="{{ url_for('run_assessment') }}" id="quickAssessForm">
              <div class="row g-2 mb-3">
                <div class="col-md-6"><input name="age" id="age" class="form-control" type="number" placeholder="Age" min="5"></div>
                <div class="col-md-6">
                  <select name="gender" id="gender" class="form-select">
                    <option value="">Gender</option>
                    <option>Male</option><option>Female</option><option>Other</option>
                  </select>
                </div>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-md-6"><input name="height" id="height" class="form-control" type="number" placeholder="Height (cm)" required min="30" step="0.1"></div>
                <div class="col-md-6"><input name="weight" id="weight" class="form-control" type="number" placeholder="Weight (kg)" required min="1" step="0.1"></div>
              </div>
              <div class="mb-3"><input name="goals" id="goals" class="form-control" placeholder="Goals (e.g., lose 5 kg in 3 months)"></div>

              <div class="d-flex gap-2 mb-2">
                <button class="btn btn-brand flex-grow-1" type="submit" id="runAssessBtn"><i class="fas fa-play me-2"></i>Run Assessment</button>
                <button class="btn btn-outline-secondary" type="button" id="calcBmiBtn" title="Calculate BMI without submitting"><i class="fas fa-calculator"></i></button>
              </div>

              <div id="instantResult" class="mt-2" style="display:none;">
                <div class="score-bar"><div id="scoreFill" class="score-bar-fill" style="width:0%"></div></div>
                <div class="mt-2 muted-small" id="bmiText"></div>
              </div>
            </form>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header d-flex align-items-center">
            <i class="fas fa-history me-2"></i> Recent Activity
            <small class="muted-small ms-auto">Tap an entry for details</small>
          </div>
          <div class="card-body p-0">
            <ul class="list-group list-group-flush" id="recentList">
              {% if logs %}
                {% for log in logs %}
                <li class="list-group-item log-row" data-type="{{ log.type }}" data-date="{{ log.date }}" data-data='{{ log.data|tojson|safe }}'>
                  {% if log.type == 'assessment' %}
                    <span class="badge-assessment">Assessment</span>
                    BMI {{ log.data.bmi }}, Score {{ log.data.score }}
                  {% else %}
                    <span class="badge-nutrition">Nutrition</span>
                    Calories {{ log.data.totals.calories }}
                  {% endif %}
                  <span class="float-end small text-muted">{{ log.date }}</span>
                </li>
                {% endfor %}
              {% else %}
                <li class="list-group-item no-logs">No logs yet — run an assessment or analyze a meal to populate the calendar.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <!-- Calendar -->
        <div class="card">
          <div class="card-header d-flex align-items-center">
            <i class="fas fa-calendar-days me-2"></i> Health Calendar
            <div class="ms-auto d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" id="todayBtn"><i class="fas fa-calendar-day me-1"></i> Today</button>
              <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn"><i class="fas fa-download"></i> Export</button>
            </div>
          </div>
          <div class="card-body"><div id="calendar" aria-label="Health calendar"></div></div>
        </div>

        <div class="mt-3 d-flex gap-3 align-items-center">
          <div><span class="badge-assessment">&nbsp;</span> Assessment</div>
          <div><span class="badge-nutrition">&nbsp;</span> Nutrition</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Log Modal -->
  <div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Entry Details</h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="logModalBody"></div>
      </div>
    </div>
  </div>

  <!-- libs: bootstrap then fullcalendar (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    // Server-passed logs (Jinja) -> always default to array
    let logs = {{ logs|tojson|default('[]')|safe }};

    // Calendar instance reference
    let calendar = null;

    // Helper: format date to YYYY-MM-DD (for calendar events)
    function fmtDate(d) {
      const dt = new Date(d);
      if (isNaN(dt)) return null;
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // Build FullCalendar events array from logs
    function buildEventsFromLogs() {
      return (Array.isArray(logs) ? logs : []).map((l, i) => {
        const date = l && l.date ? l.date : null;
        if (!date) return null;
        return {
          id: `${i}-${l.type}`,
          title: (l.type === 'assessment' ? 'Assessment' : 'Nutrition'),
          start: date,
          allDay: true,
          color: (l.type === 'assessment' ? '#0fb15d' : '#2563eb'),
          extendedProps: { raw: l.data, type: l.type, date: date }
        };
      }).filter(Boolean);
    }

    // Render recent activity list DOM
    function renderRecentList() {
      const ul = document.getElementById('recentList');
      ul.innerHTML = '';
      if (!Array.isArray(logs) || logs.length === 0) {
        ul.innerHTML = '<li class="list-group-item no-logs">No logs yet — run an assessment or analyze a meal to populate the calendar.</li>';
        return;
      }
      logs.slice().reverse().forEach(l => { // newest first
        const li = document.createElement('li');
        li.className = 'list-group-item log-row';
        li.dataset.type = l.type || 'assessment';
        li.dataset.date = l.date || '';
        li.dataset.data = JSON.stringify(l.data || {});
        const badge = document.createElement('span');
        badge.className = (l.type === 'assessment' ? 'badge-assessment' : 'badge-nutrition');
        badge.textContent = (l.type === 'assessment' ? 'Assessment' : 'Nutrition');
        li.appendChild(badge);
        const text = document.createTextNode(' ' + (l.type === 'assessment' ? `BMI ${l.data.bmi || '-'}, Score ${l.data.score || '-'}` : `Calories ${l.data.totals ? (l.data.totals.calories || 0) : 0}`));
        li.appendChild(text);
        const spanDate = document.createElement('span');
        spanDate.className = 'float-end small text-muted';
        spanDate.textContent = l.date || '';
        li.appendChild(spanDate);
        li.addEventListener('click', () => {
          try {
            const raw = JSON.parse(li.dataset.data);
            showLogModal({ raw: raw, type: li.dataset.type, date: li.dataset.date });
          } catch (err) {
            console.warn('Failed to parse log row data:', err);
          }
        });
        ul.appendChild(li);
      });
    }

    // Add event to calendar (or rerender)
    function refreshCalendar() {
      if (!calendar) return;
      calendar.removeAllEvents();
      const events = buildEventsFromLogs();
      events.forEach(ev => calendar.addEvent(ev));
    }

    // Show modal for a log entry
    function showLogModal(props) {
      const d = props.raw || {}; let html = '';
      if (props.type === 'assessment') {
        html += `<p><strong>Score:</strong> ${d.score || '-'} &nbsp;|&nbsp; <strong>BMI:</strong> ${d.bmi || '-'} &nbsp;|&nbsp; <strong>Status:</strong> ${d.status || '-'}</p>`;
        if (d.recommendations && d.recommendations.length) html += '<h6>Recommendations</h6><ul>' + d.recommendations.map(r => `<li>${r}</li>`).join('') + '</ul>';
      } else if (props.type === 'nutrition') {
        const t = d.totals || {}; html += `<p><strong>Totals:</strong> Calories ${t.calories || 0}, Protein ${t.protein || 0}g, Carbs ${t.carbs || 0}g, Fat ${t.fat || 0}g</p>`;
        if (d.items && d.items.length) html += '<h6>Detected items</h6><ul>' + d.items.map(it => `<li>${it.name} — ${it.calories || 0} kcal</li>`).join('') + '</ul>';
        if (d.image_data) html += `<div class="mt-3"><img src="data:image/jpeg;base64,${d.image_data}" alt="meal" style="max-width:100%;border-radius:8px;"/></div>`;
      }
      document.getElementById('logModalBody').innerHTML = html || '<p class="muted-small">No details available.</p>';
      new bootstrap.Modal(document.getElementById('logModal')).show();
    }

    // Instant BMI calc and UI update
    function calcAndShowBMI() {
      const h = parseFloat(document.getElementById('height').value);
      const w = parseFloat(document.getElementById('weight').value);
      if (!h || !w) return null;
      const h_m = h / 100;
      const bmi = +(w / (h_m * h_m)).toFixed(1);
      // simple score mapping for display (not authoritative)
      let score = 50;
      if (bmi < 18.5) score = 60;
      else if (bmi < 25) score = 90;
      else if (bmi < 30) score = 70;
      else score = 45;
      document.getElementById('instantResult').style.display = 'block';
      const fill = document.getElementById('scoreFill');
      fill.style.width = `${Math.max(6, Math.min(100, score))}%`;
      fill.style.background = (score >= 80 ? 'linear-gradient(90deg,#28a745,#0fb15d)' : (score >= 60 ? '#f59e0b' : '#ef4444'));
      document.getElementById('bmiText').textContent = `BMI: ${bmi} • Simple score: ${score}`;
      return { bmi, score };
    }

    // Submit assessment via fetch (AJAX)
    async function submitAssessment(ev) {
      ev.preventDefault();
      const btn = document.getElementById('runAssessBtn');
      if (btn.disabled) return;
      const age = document.getElementById('age').value || '';
      const gender = document.getElementById('gender').value || '';
      const height = document.getElementById('height').value || '';
      const weight = document.getElementById('weight').value || '';
      const goals = document.getElementById('goals').value || '';

      // compute BMI locally as fallback/preview
      const bmiRes = calcAndShowBMI();
      const payload = { age, gender, height, weight, goals, bmi: (bmiRes && bmiRes.bmi) ? bmiRes.bmi : null };

      // disable button & show spinner
      btn.disabled = true;
      const origText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Running...';

      try {
        // POST to your Flask endpoint - expects JSON response (adapt if needed)
        const resp = await fetch("{{ url_for('run_assessment') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          // try fallback to form POST (non-AJAX) if server doesn't accept JSON
          console.warn('AJAX POST failed, falling back to native submit. Status:', resp.status);
          document.getElementById('quickAssessForm').submit();
          return;
        }

        const data = await resp.json();

        if (data && data.success) {
          // append new log if returned
          if (data.log) {
            // server returns one log object (recommended):
            logs = Array.isArray(data.logs) ? data.logs : (Array.isArray(logs) ? logs.concat([data.log]) : [data.log]);
          } else if (Array.isArray(data.logs)) {
            // server returns an updated logs array
            logs = data.logs;
          }
          // update UI
          renderRecentList();
          refreshCalendar();

          // show result immediately (if server returned log.data)
          const newLog = data.log || (logs.length ? logs[logs.length-1] : null);
          if (newLog) {
            showLogModal({ raw: newLog.data || {}, type: newLog.type || 'assessment', date: newLog.date || fmtDate(new Date()) });
          } else {
            // fallback toast
            const toastEl = document.createElement('div');
            toastEl.className = 'position-fixed bottom-0 end-0 m-3 p-2 bg-success text-white rounded';
            toastEl.textContent = 'Assessment saved';
            document.body.appendChild(toastEl);
            setTimeout(() => toastEl.remove(), 2500);
          }
        } else {
          console.warn('Server responded with error or unexpected format', data);
          alert((data && data.message) ? data.message : 'Failed to run assessment — check server logs.');
        }
      } catch (err) {
        console.error('Assessment submit error', err);
        // fallback to non-AJAX submit to keep behaviour safe
        document.getElementById('quickAssessForm').submit();
      } finally {
        btn.disabled = false;
        btn.innerHTML = origText;
      }
    }

    // CSV export (uses current logs array)
    function exportCsv() {
      let rows = [['date','type','payload']];
      (Array.isArray(logs) ? logs : []).forEach(l => rows.push([l.date || '', l.type || '', JSON.stringify(l.data || {})]));
      const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fit_smart_logs.csv'; a.click();
    }

    // Initialize calendar and UI on window load
    window.addEventListener('load', () => {
      try {
        // FullCalendar check
        if (typeof FullCalendar === 'undefined') {
          console.error('FullCalendar not loaded. Check CDN.');
          return;
        }

        // instantiate calendar in outer scope
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
          events: buildEventsFromLogs(),
          navLinks: true,
          dayMaxEvents: true,
          editable: false,
          eventClick: info => {
            showLogModal(info.event.extendedProps);
          }
        });
        calendar.render();

        // Wire buttons
        document.getElementById('todayBtn').addEventListener('click', () => calendar.today());
        document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);

        // BMI calculator button
        document.getElementById('calcBmiBtn').addEventListener('click', () => {
          const res = calcAndShowBMI();
          if (!res) {
            alert('Enter valid height (cm) and weight (kg) to calculate BMI.');
          }
        });

        // Form submit (AJAX)
        const form = document.getElementById('quickAssessForm');
        if (form) form.addEventListener('submit', submitAssessment);

        // Render initial recent list & attach click handlers
        renderRecentList();

      } catch (err) {
        console.error('Initialization error:', err);
      }
    });
  </script>
</body>
</html>
